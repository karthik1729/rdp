var Channel, Connection, Entity, Flow, Message, StateBus, System;

System = (function() {
  function System(name, flow) {
    this.name = name;
    this.flow = flow;
    this.handlers = null;
  }

  System.prototype.push = function(data, inlet) {};

  System.prototype.whenReady = function(handler, outlet) {
    if (!outlet) {
      if (this.handlers === null) {
        return this.handlers.push(handler);
      } else {
        return this.handlers = [handler];
      }
    } else {
      if (this.handlers === null) {
        return this.handlers.outlet = [handler];
      } else {
        return this.handlers.outlet.push(handler);
      }
    }
  };

  System.prototype.emit = function(data, outlet) {
    var handler, _i, _j, _len, _len1, _ref, _ref1, _results, _results1;
    if (!outlet) {
      _ref = this.handlers;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        handler = _ref[_i];
        _results.push(handler(data));
      }
      return _results;
    } else {
      _ref1 = this.handlers[outlet];
      _results1 = [];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        handler = _ref1[_j];
        _results1.push(handler(data));
      }
      return _results1;
    }
  };

  System.prototype.serialize = function() {
    return "<system name=\"" + this.name + "\" />";
  };

  return System;

})();

Channel = (function() {
  function Channel(inlet, outlet) {
    this.inlet = inlet;
    this.outlet = outlet;
  }

  Channel.prototype.serialize = function() {
    return "<channel inlet='" + this.inlet + "', outlet='" + this.outlet + "'/>";
  };

  return Channel;

})();

Connection = (function() {
  function Connection(name, flow, source, sink, channels) {
    var channel, self, _i, _len, _ref;
    this.name = name;
    this.flow = flow;
    this.channels = channels;
    self = this;
    this.source = this.flow.getSystem(source);
    this.sink = this.flow.getSystem(sink);
    this.flow.log("" + this.source.name + " ---> " + this.name + " ---> " + this.sink.name);
    if (this.channels) {
      _ref = this.channels;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        channel = _ref[_i];
        this.source.prototype.whenReady((function(data) {
          return self.sink.prototype.push(channel.inlet, data);
        }), channel.outlet);
      }
    } else {
      this.source.prototype.whenReady(function(data) {
        return self.sink.prototype.push(data);
      });
    }
  }

  Connection.prototype.serialize = function() {
    var channel, xml, _i, _len, _ref;
    xml = "<connection name='" + this.name + "'>\n    " + (this.source.serialize()) + "\n    " + (this.sink.serialize());
    if (this.channels) {
      xml += "<channels>";
      _ref = this.channels;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        channel = _ref[_i];
        xml += channel.serialize();
      }
      xml += "</channels>";
    }
    return xml += "</connection>";
  };

  return Connection;

})();

Message = (function() {
  function Message(event, payload) {
    this.event = event;
    this.payload = payload;
  }

  return Message;

})();

Entity = (function() {
  function Entity(name) {
    this.name = name;
  }

  return Entity;

})();

StateBus = (function() {
  function StateBus() {
    this.entities = {};
    this.discreteSystems = {};
  }

  StateBus.prototype.createEntity = function(name) {
    this.entities[name] = new Entity(name);
    return this.entities[name];
  };

  StateBus.prototype.getEntity = function(name, create) {
    if (this.entities[name]) {
      return this.entities[name];
    } else if (create) {
      return this.createEntity(name);
    } else {
      return null;
    }
  };

  StateBus.prototype.addDiscreteSystem = function(discrete_system, events) {
    var event, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = events.length; _i < _len; _i++) {
      event = events[_i];
      if (this.discreteSystems[event].systems === null) {
        _results.push(this.discreteSystems[event].systems = [discrete_system]);
      } else {
        _results.push(this.discreteSystems[event].systems.append(discrete_system));
      }
    }
    return _results;
  };

  StateBus.prototype.trigger = function(event, message) {
    var system, _i, _len, _ref, _results;
    _ref = this.discreteSystems[event];
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      system = _ref[_i];
      message = -Message(event, message);
      _results.push(system.raise(message));
    }
    return _results;
  };

  return StateBus;

})();

Flow = (function() {
  function Flow() {
    this.connections = [];
    this.bus = new StateBus;
    this.systems = {};
  }

  Flow.prototype.addSystem = function(system) {
    return this.systems[system.name] = system;
  };

  Flow.prototype.getSystem = function(name) {
    return this.systems[name];
  };

  Flow.prototype.addConnection = function(connection) {
    return this.connections.push(connection);
  };

  Flow.prototype.serialize = function() {
    var connection, xml, _i, _len, _ref;
    xml = "<xml>";
    xml += "<flow name='" + this.name + "'>";
    _ref = this.connections;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      connection = _ref[_i];
      xml += "<connection>";
      xml += connection.serialize();
      xml += "</connection>";
    }
    xml = "</flow>";
    return xml = "</xml>";
  };

  Flow.prototype.log = function(x) {
    return console.log(x);
  };

  return Flow;

})();

exports.System = System;

exports.Channel = Channel;

exports.Connection = Connection;

exports.Message = Message;

exports.StateBus = StateBus;

exports.Flow = Flow;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzIjpbImluZGV4LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLDREQUFBOztBQUFBO0FBRWdCLEVBQUEsZ0JBQUUsSUFBRixFQUFTLElBQVQsR0FBQTtBQUNSLElBRFMsSUFBQyxDQUFBLE9BQUEsSUFDVixDQUFBO0FBQUEsSUFEZ0IsSUFBQyxDQUFBLE9BQUEsSUFDakIsQ0FBQTtBQUFBLElBQUEsSUFBQyxDQUFBLFFBQUQsR0FBWSxJQUFaLENBRFE7RUFBQSxDQUFaOztBQUFBLG1CQUlBLElBQUEsR0FBTSxTQUFDLElBQUQsRUFBTyxLQUFQLEdBQUEsQ0FKTixDQUFBOztBQUFBLG1CQU1BLFNBQUEsR0FBVyxTQUFDLE9BQUQsRUFBVSxNQUFWLEdBQUE7QUFFUCxJQUFBLElBQUcsQ0FBQSxNQUFIO0FBQ0ksTUFBQSxJQUFHLElBQUMsQ0FBQSxRQUFELEtBQWEsSUFBaEI7ZUFDSSxJQUFDLENBQUEsUUFBUSxDQUFDLElBQVYsQ0FBZSxPQUFmLEVBREo7T0FBQSxNQUFBO2VBR0csSUFBQyxDQUFBLFFBQUQsR0FBWSxDQUFDLE9BQUQsRUFIZjtPQURKO0tBQUEsTUFBQTtBQU9JLE1BQUEsSUFBRyxJQUFDLENBQUEsUUFBRCxLQUFhLElBQWhCO2VBQ0ksSUFBQyxDQUFBLFFBQVEsQ0FBQyxNQUFWLEdBQW1CLENBQUMsT0FBRCxFQUR2QjtPQUFBLE1BQUE7ZUFHSSxJQUFDLENBQUEsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFqQixDQUFzQixPQUF0QixFQUhKO09BUEo7S0FGTztFQUFBLENBTlgsQ0FBQTs7QUFBQSxtQkFvQkEsSUFBQSxHQUFNLFNBQUMsSUFBRCxFQUFPLE1BQVAsR0FBQTtBQUVGLFFBQUEsOERBQUE7QUFBQSxJQUFBLElBQUcsQ0FBQSxNQUFIO0FBQ0k7QUFBQTtXQUFBLDJDQUFBOzJCQUFBO0FBQ0ksc0JBQUEsT0FBQSxDQUFRLElBQVIsRUFBQSxDQURKO0FBQUE7c0JBREo7S0FBQSxNQUFB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IGNvbnN0cnVjdG9yOihAbmFtZSwgQGZsb3cpIC0+XG4gICAgICAgIEBoYW5kbGVycyA9IG51bGxcblxuICAgICMganVzdCBkYXRhIGZvciBzaW5nbGUgaW5sZXRcbiAgICBwdXNoOiAoZGF0YSwgaW5sZXQpIC0+XG5cbiAgICB3aGVuUmVhZHk6IChoYW5kbGVyLCBvdXRsZXQpIC0+XG5cbiAgICAgICAgaWYgbm90IG91dGxldFxuICAgICAgICAgICAgaWYgQGhhbmRsZXJzID09IG51bGxcbiAgICAgICAgICAgICAgICBAaGFuZGxlcnMucHVzaChoYW5kbGVyKVxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgQGhhbmRsZXJzID0gW2hhbmRsZXJdXG5cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgaWYgQGhhbmRsZXJzID09IG51bGxcbiAgICAgICAgICAgICAgICBAaGFuZGxlcnMub3V0bGV0ID0gW2hhbmRsZXJdXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgQGhhbmRsZXJzLm91dGxldC5wdXNoKGhhbmRsZXIpXG5cbiAgICBlbWl0OiAoZGF0YSwgb3V0bGV0KSAtPlxuXG4gICAgICAgIGlmIG5vdCBvdXRsZXRcbiAgICAgICAgICAgIGZvciBoYW5kbGVyIGluIEBoYW5kbGVyc1xuICAgICAgICAgICAgICAgIGhhbmRsZXIoZGF0YSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgZm9yIGhhbmRsZXIgaW4gQGhhbmRsZXJzW291dGxldF1cbiAgICAgICAgICAgICAgICBoYW5kbGVyKGRhdGEpXG5cbiAgICBzZXJpYWxpemU6IC0+XG4gICAgICAgIFwiXCJcIlxuICAgICAgICA8c3lzdGVtIG5hbWU9XCIje0BuYW1lfVwiIC8+XG4gICAgICAgIFwiXCJcIlxuXG5jbGFzcyBDaGFubmVsXG5cbiAgICBjb25zdHJ1Y3RvcjogKEBpbmxldCwgQG91dGxldCkgLT5cblxuICAgIHNlcmlhbGl6ZTogLT5cbiAgICAgICAgXCI8Y2hhbm5lbCBpbmxldD0nI3tAaW5sZXR9Jywgb3V0bGV0PScje0BvdXRsZXR9Jy8+XCJcblxuY2xhc3MgQ29ubmVjdGlvblxuXG4gICAgY29uc3RydWN0b3I6IChAbmFtZSwgQGZsb3csIHNvdXJjZSwgc2luaywgQGNoYW5uZWxzKSAtPlxuICAgICAgICBzZWxmID0gdGhpc1xuICAgICAgICBAc291cmNlID0gQGZsb3cuZ2V0U3lzdGVtKHNvdXJjZSlcbiAgICAgICAgQHNpbmsgPSBAZmxvdy5nZXRTeXN0ZW0oc2luaylcbiAgICAgICAgQGZsb3cubG9nKFwiI3tAc291cmNlLm5hbWV9IC0tLT4gI3tAbmFtZX0gLS0tPiAje0BzaW5rLm5hbWV9XCIpXG5cbiAgICAgICAgaWYgQGNoYW5uZWxzXG4gICAgICAgICAgICBmb3IgY2hhbm5lbCBpbiBAY2hhbm5lbHNcbiAgICAgICAgICAgICAgICBAc291cmNlLnByb3RvdHlwZS53aGVuUmVhZHkoKChkYXRhKSAtPlxuICAgICAgICAgICAgICAgICAgICBzZWxmLnNpbmsucHJvdG90eXBlLnB1c2goY2hhbm5lbC5pbmxldCwgZGF0YSkpLFxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsLm91dGxldClcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgQHNvdXJjZS5wcm90b3R5cGUud2hlblJlYWR5IChkYXRhKSAtPlxuICAgICAgICAgICAgICAgICMgc2VsZi5mbG93LmxvZyhkYXRhKVxuICAgICAgICAgICAgICAgIHNlbGYuc2luay5wcm90b3R5cGUucHVzaChkYXRhKVxuXG4gICAgc2VyaWFsaXplOiAtPlxuICAgICAgICAgICAgeG1sID0gXCJcIlwiXG4gICAgICAgICAgICA8Y29ubmVjdGlvbiBuYW1lPScje0BuYW1lfSc+XG4gICAgICAgICAgICAgICAgI3tAc291cmNlLnNlcmlhbGl6ZSgpfVxuICAgICAgICAgICAgICAgICN7QHNpbmsuc2VyaWFsaXplKCl9XG4gICAgICAgICAgICBcIlwiXCJcblxuICAgICAgICAgICAgaWYgQGNoYW5uZWxzXG4gICAgICAgICAgICAgICAgeG1sICs9IFwiPGNoYW5uZWxzPlwiXG4gICAgICAgICAgICAgICAgZm9yIGNoYW5uZWwgaW4gQGNoYW5uZWxzXG4gICAgICAgICAgICAgICAgICAgIHhtbCArPSBjaGFubmVsLnNlcmlhbGl6ZSgpXG4gICAgICAgICAgICAgICAgeG1sICs9IFwiPC9jaGFubmVscz5cIlxuXG4gICAgICAgICAgICB4bWwgKz0gXCI8L2Nvbm5lY3Rpb24+XCJcblxuY2xhc3MgTWVzc2FnZVxuXG4gICAgY29uc3RydWN0b3I6IChAZXZlbnQsIEBwYXlsb2FkKSAtPlxuXG5jbGFzcyBFbnRpdHlcblxuICAgIGNvbnN0cnVjdG9yOiAoQG5hbWUpIC0+XG5cbmNsYXNzIFN0YXRlQnVzXG5cbiAgICBjb25zdHJ1Y3RvcjogLT5cbiAgICAgICAgQGVudGl0aWVzID0ge31cbiAgICAgICAgQGRpc2NyZXRlU3lzdGVtcyA9IHt9XG5cbiAgICBjcmVhdGVFbnRpdHk6IChuYW1lKSAtPlxuICAgICAgICBAZW50aXRpZXNbbmFtZV0gPSBuZXcgRW50aXR5KG5hbWUpXG4gICAgICAgIEBlbnRpdGllc1tuYW1lXVxuXG4gICAgZ2V0RW50aXR5OiAobmFtZSwgY3JlYXRlKSAtPlxuICAgICAgICBpZiBAZW50aXRpZXNbbmFtZV1cbiAgICAgICAgICAgIHJldHVybiBAZW50aXRpZXNbbmFtZV1cbiAgICAgICAgZWxzZSBpZiBjcmVhdGVcbiAgICAgICAgICAgIHJldHVybiBAY3JlYXRlRW50aXR5KG5hbWUpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHJldHVybiBudWxsXG5cbiAgICBhZGREaXNjcmV0ZVN5c3RlbTogKGRpc2NyZXRlX3N5c3RlbSwgZXZlbnRzKSAtPlxuXG4gICAgICAgIGZvciBldmVudCBpbiBldmVudHNcblxuICAgICAgICAgICAgaWYgQGRpc2NyZXRlU3lzdGVtc1tldmVudF0uc3lzdGVtcyBpcyBudWxsXG4gICAgICAgICAgICAgICAgQGRpc2NyZXRlU3lzdGVtc1tldmVudF0uc3lzdGVtcyA9IFtkaXNjcmV0ZV9zeXN0ZW1dXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgQGRpc2NyZXRlU3lzdGVtc1tldmVudF0uc3lzdGVtcy5hcHBlbmQoZGlzY3JldGVfc3lzdGVtKVxuXG4gICAgdHJpZ2dlcjogKGV2ZW50LCBtZXNzYWdlKSAtPlxuXG4gICAgICAgIGZvciBzeXN0ZW0gaW4gQGRpc2NyZXRlU3lzdGVtc1tldmVudF1cbiAgICAgICAgICAgIG1lc3NhZ2UgPS0gTWVzc2FnZShldmVudCwgbWVzc2FnZSlcbiAgICAgICAgICAgIHN5c3RlbS5yYWlzZShtZXNzYWdlKVxuXG5jbGFzcyBGbG93XG5cbiAgICBjb25zdHJ1Y3RvcjogLT5cblxuICAgICAgICAjIGNvdWxkIGJlIGEgb3JkZXJlZCBtYXBcbiAgICAgICAgQGNvbm5lY3Rpb25zID0gW11cbiAgICAgICAgQGJ1cyA9IG5ldyBTdGF0ZUJ1c1xuICAgICAgICBAc3lzdGVtcyA9IHt9XG5cbiAgICBhZGRTeXN0ZW06IChzeXN0ZW0pIC0+XG4gICAgICAgIEBzeXN0ZW1zW3N5c3RlbS5uYW1lXSA9IHN5c3RlbVxuXG4gICAgZ2V0U3lzdGVtOiAobmFtZSkgLT5cbiAgICAgICAgQHN5c3RlbXNbbmFtZV1cblxuICAgIGFkZENvbm5lY3Rpb246IChjb25uZWN0aW9uKSAtPlxuICAgICAgICBAY29ubmVjdGlvbnMucHVzaChjb25uZWN0aW9uKVxuXG4gICAgc2VyaWFsaXplOiAtPlxuICAgICAgICB4bWwgPSBcIjx4bWw+XCJcbiAgICAgICAgeG1sICs9IFwiPGZsb3cgbmFtZT0nI3tAbmFtZX0nPlwiXG5cbiAgICAgICAgZm9yIGNvbm5lY3Rpb24gaW4gQGNvbm5lY3Rpb25zXG4gICAgICAgICAgICB4bWwgKz0gXCI8Y29ubmVjdGlvbj5cIlxuICAgICAgICAgICAgeG1sICs9IGNvbm5lY3Rpb24uc2VyaWFsaXplKClcbiAgICAgICAgICAgIHhtbCArPSBcIjwvY29ubmVjdGlvbj5cIlxuXG4gICAgICAgIHhtbCA9IFwiPC9mbG93PlwiXG4gICAgICAgIHhtbCA9IFwiPC94bWw+XCJcblxuICAgIGxvZzogKHgpIC0+XG4gICAgICAgIGNvbnNvbGUubG9nKHgpXG5cblxuXG5leHBvcnRzLlN5c3RlbSA9IFN5c3RlbVxuZXhwb3J0cy5DaGFubmVsID0gQ2hhbm5lbFxuZXhwb3J0cy5Db25uZWN0aW9uID0gQ29ubmVjdGlvblxuZXhwb3J0cy5NZXNzYWdlID0gTWVzc2FnZVxuZXhwb3J0cy5TdGF0ZUJ1cyA9IFN0YXRlQnVzXG5leHBvcnRzLkZsb3cgPSBGbG93XG5cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==