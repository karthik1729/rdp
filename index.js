var Channel, Connection, Flow, Message, StateBus, System;

System = (function() {
  function System(name, flow) {
    this.name = name;
    this.flow = flow;
    this.handlers = null;
  }

  System.prototype.push = function(data, inlet) {};

  System.prototype.whenReady = function(handler, outlet) {
    if (!outlet) {
      if (this.handlers) {
        return this.handlers.push(handler);
      } else {
        return this.handlers = [handler];
      }
    } else {
      if (this.handlers.outlet === null) {
        return this.handlers.outlet = [handler];
      } else {
        return this.handlers.outlet.push(handler);
      }
    }
  };

  System.prototype.emit = function(data, outlet) {
    var handler, _i, _j, _len, _len1, _ref, _ref1, _results, _results1;
    if (!outlet) {
      _ref = this.handlers;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        handler = _ref[_i];
        _results.push(handler(data));
      }
      return _results;
    } else {
      _ref1 = this.handlers[outlet];
      _results1 = [];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        handler = _ref1[_j];
        _results1.push(handler(data));
      }
      return _results1;
    }
  };

  System.prototype.serialize = function() {
    return "<system name=\"" + this.name + "\" />";
  };

  return System;

})();

Channel = (function() {
  function Channel(inlet, outlet) {
    this.inlet = inlet;
    this.outlet = outlet;
  }

  Channel.prototype.serialize = function() {
    return "<channel inlet='" + this.inlet + "', outlet='" + this.outlet + "'/>";
  };

  return Channel;

})();

Connection = (function() {
  function Connection(name, flow, source, sink, channels) {
    this.name = name;
    this.flow = flow;
    this.channels = channels;
    this.source = this.flow.getSystem(source);
    this.sink = this.flow.getSystem(sink);
  }

  Connection.prototype.serialize = function() {
    var channel, xml, _i, _len, _ref;
    xml = "<connection name='" + this.name + "'>\n    " + (this.source.serialize()) + "\n    " + (this.sink.serialize());
    if (this.channels) {
      xml += "<channels>";
      _ref = this.channels;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        channel = _ref[_i];
        xml += channel.serialize();
      }
      xml += "</channels>";
    }
    return xml += "</connection>";
  };

  return Connection;

})();

Message = (function() {
  function Message(event, payload) {
    this.event = event;
    this.payload = payload;
  }

  return Message;

})();

StateBus = (function() {
  function StateBus() {
    this.entities = {};
    this.discreteSystems = {};
  }

  StateBus.prototype.addEntity = function(entity) {
    return this.entities[entiy.name] = entity;
  };

  StateBus.prototype.getEntity = function(name, create) {
    if (this.entities[name]) {
      return this.entities[name];
    } else if (create) {
      this.entities[name] = {};
      return this.entities[name];
    } else {
      return null;
    }
  };

  StateBus.prototype.addDiscreteSystem = function(discrete_system, events) {
    var event, _i, _len;
    for (_i = 0, _len = events.length; _i < _len; _i++) {
      event = events[_i];
      if (this.discreteSystems[event].systems === null) {
        this.discreteSystems[event].systems = [discrete_system];
      } else {
        this.discreteSystems[event].systems.append(discrete_system);
      }
    }
    return {
      trigger: function(event, message) {
        var system, _j, _len1, _ref, _results;
        _ref = this.discreteSystems[event];
        _results = [];
        for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
          system = _ref[_j];
          message = -Message(event, message);
          _results.push(system.raise(message));
        }
        return _results;
      }
    };
  };

  return StateBus;

})();

Flow = (function() {
  function Flow() {
    this.connections = [];
    this.bus = new StateBus;
    this.systems = {};
  }

  Flow.prototype.addSystem = function(system) {
    return this.systems[system.name] = system;
  };

  Flow.prototype.getSystem = function(name) {
    return this.systems[name];
  };

  Flow.prototype.addConnection = function(connection) {
    return this.connections.push(connection);
  };

  Flow.prototype.serialize = function() {
    var connection, xml, _i, _len, _ref;
    xml = "<xml>";
    xml += "<flow name='" + this.name + "'>";
    _ref = this.connections;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      connection = _ref[_i];
      xml += "<connection>";
      xml += connection.serialize();
      xml += "</connection>";
    }
    xml = "</flow>";
    return xml = "</xml>";
  };

  Flow.prototype.log = function(x) {
    return console.log(x);
  };

  Flow.prototype.start = function() {
    var A, B, channel, connection, _i, _len, _ref, _results;
    _ref = this.connections;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      connection = _ref[_i];
      A = connection.source;
      B = connection.sink;
      this.log("" + A.name + " -- " + B.name);
      if (connection.channels) {
        _results.push((function() {
          var _j, _len1, _ref1, _results1;
          _ref1 = connection.channels;
          _results1 = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            channel = _ref1[_j];
            _results1.push(A.whenReady((function(data) {
              return B.push(inlet, data);
            }), A.channel.outlet));
          }
          return _results1;
        })());
      } else {
        _results.push(A.whenReady(function(data) {
          return B.push(data);
        }));
      }
    }
    return _results;
  };

  return Flow;

})();

exports.System = System;

exports.Channel = Channel;

exports.Connection = Connection;

exports.Message = Message;

exports.StateBus = StateBus;

exports.Flow = Flow;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzIjpbImluZGV4LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLG9EQUFBOztBQUFBO0FBRWdCLEVBQUEsZ0JBQUUsSUFBRixFQUFTLElBQVQsR0FBQTtBQUNSLElBRFMsSUFBQyxDQUFBLE9BQUEsSUFDVixDQUFBO0FBQUEsSUFEZ0IsSUFBQyxDQUFBLE9BQUEsSUFDakIsQ0FBQTtBQUFBLElBQUEsSUFBQyxDQUFBLFFBQUQsR0FBWSxJQUFaLENBRFE7RUFBQSxDQUFaOztBQUFBLG1CQUlBLElBQUEsR0FBTSxTQUFDLElBQUQsRUFBTyxLQUFQLEdBQUEsQ0FKTixDQUFBOztBQUFBLG1CQU1BLFNBQUEsR0FBVyxTQUFDLE9BQUQsRUFBVSxNQUFWLEdBQUE7QUFFUCxJQUFBLElBQUcsQ0FBQSxNQUFIO0FBQ0ksTUFBQSxJQUFHLElBQUMsQ0FBQSxRQUFKO2VBQ0ksSUFBQyxDQUFBLFFBQVEsQ0FBQyxJQUFWLENBQWUsT0FBZixFQURKO09BQUEsTUFBQTtlQUdHLElBQUMsQ0FBQSxRQUFELEdBQVksQ0FBQyxPQUFELEVBSGY7T0FESjtLQUFBLE1BQUE7QUFPSSxNQUFBLElBQUcsSUFBQyxDQUFBLFFBQVEsQ0FBQyxNQUFWLEtBQW9CLElBQXZCO2VBQ0ksSUFBQyxDQUFBLFFBQVEsQ0FBQyxNQUFWLEdBQW1CLENBQUMsT0FBRCxFQUR2QjtPQUFBLE1BQUE7ZUFHSSxJQUFDLENBQUEsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFqQixDQUFzQixPQUF0QixFQUhKO09BUEo7S0FGTztFQUFBLENBTlgsQ0FBQTs7QUFBQSxtQkFvQkEsSUFBQSxHQUFNLFNBQUMsSUFBRCxFQUFPLE1BQVAsR0FBQTtBQUVGLFFBQUEsOERBQUE7QUFBQSxJQUFBLElBQUcsQ0FBQSxNQUFIO0FBQ0k7QUFBQTtXQUFBLDJDQUFBOzJCQUFBO0FBQ0ksc0JBQUEsT0FBQSxDQUFRLElBQVIsRUFBQSxDQURKO0FBQUE7c0JBREo7S0FBQSxNQUFB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O0FBQUEsTUFDQSxDQUFBLEdBQUksVUFBVSxDQUFDLElBRGYsQ0FBQTtBQUFBLE1BR0EsSUFBSSxDQUFDLEdBQUwsQ0FBUyxFQUFBLEdBQUUsQ0FBQyxDQUFDLElBQUosR0FBVSxNQUFWLEdBQWUsQ0FBQyxDQUFDLElBQTFCLENBSEEsQ0FBQTtBQUtBLE1BQUEsSUFBRyxVQUFVLENBQUMsUUFBZDs7O0FBQ0k7QUFBQTtlQUFBLDhDQUFBO2dDQUFBO0FBQ0ksMkJBQUEsQ0FBQyxDQUFDLFNBQUYsQ0FBWSxDQUFDLFNBQUMsSUFBRCxHQUFBO3FCQUNULENBQUMsQ0FBQyxJQUFGLENBQU8sS0FBUCxFQUFjLElBQWQsRUFEUztZQUFBLENBQUQsQ0FBWixFQUVJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFGZCxFQUFBLENBREo7QUFBQTs7Y0FESjtPQUFBLE1BQUE7c0JBTUksQ0FBQyxDQUFDLFNBQUYsQ0FBWSxTQUFDLElBQUQsR0FBQTtpQkFDUixDQUFDLENBQUMsSUFBRixDQUFPLElBQVAsRUFEUTtRQUFBLENBQVosR0FOSjtPQVBKO0FBQUE7b0JBRkc7RUFBQSxDQS9CUCxDQUFBOztjQUFBOztJQXZHSixDQUFBOztBQUFBLE9BeUpPLENBQUMsTUFBUixHQUFpQixNQXpKakIsQ0FBQTs7QUFBQSxPQTBKTyxDQUFDLE9BQVIsR0FBa0IsT0ExSmxCLENBQUE7O0FBQUEsT0EySk8sQ0FBQyxVQUFSLEdBQXFCLFVBM0pyQixDQUFBOztBQUFBLE9BNEpPLENBQUMsT0FBUixHQUFrQixPQTVKbEIsQ0FBQTs7QUFBQSxPQTZKTyxDQUFDLFFBQVIsR0FBbUIsUUE3Sm5CLENBQUE7O0FBQUEsT0E4Sk8sQ0FBQyxJQUFSLEdBQWUsSUE5SmYsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImNsYXNzIFN5c3RlbVxuXG4gICAgY29uc3RydWN0b3I6KEBuYW1lLCBAZmxvdykgLT5cbiAgICAgICAgQGhhbmRsZXJzID0gbnVsbFxuXG4gICAgIyBqdXN0IGRhdGEgZm9yIHNpbmdsZSBpbmxldFxuICAgIHB1c2g6IChkYXRhLCBpbmxldCkgLT5cblxuICAgIHdoZW5SZWFkeTogKGhhbmRsZXIsIG91dGxldCkgLT5cblxuICAgICAgICBpZiBub3Qgb3V0bGV0XG4gICAgICAgICAgICBpZiBAaGFuZGxlcnNcbiAgICAgICAgICAgICAgICBAaGFuZGxlcnMucHVzaChoYW5kbGVyKVxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgQGhhbmRsZXJzID0gW2hhbmRsZXJdXG5cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgaWYgQGhhbmRsZXJzLm91dGxldCBpcyBudWxsXG4gICAgICAgICAgICAgICAgQGhhbmRsZXJzLm91dGxldCA9IFtoYW5kbGVyXVxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIEBoYW5kbGVycy5vdXRsZXQucHVzaCBoYW5kbGVyXG5cbiAgICBlbWl0OiAoZGF0YSwgb3V0bGV0KSAtPlxuXG4gICAgICAgIGlmIG5vdCBvdXRsZXRcbiAgICAgICAgICAgIGZvciBoYW5kbGVyIGluIEBoYW5kbGVyc1xuICAgICAgICAgICAgICAgIGhhbmRsZXIoZGF0YSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgZm9yIGhhbmRsZXIgaW4gQGhhbmRsZXJzW291dGxldF1cbiAgICAgICAgICAgICAgICBoYW5kbGVyKGRhdGEpXG5cbiAgICBzZXJpYWxpemU6IC0+XG4gICAgICAgIFwiXCJcIlxuICAgICAgICA8c3lzdGVtIG5hbWU9XCIje0BuYW1lfVwiIC8+XG4gICAgICAgIFwiXCJcIlxuXG5jbGFzcyBDaGFubmVsXG5cbiAgICBjb25zdHJ1Y3RvcjogKEBpbmxldCwgQG91dGxldCkgLT5cblxuICAgIHNlcmlhbGl6ZTogLT5cbiAgICAgICAgXCI8Y2hhbm5lbCBpbmxldD0nI3tAaW5sZXR9Jywgb3V0bGV0PScje0BvdXRsZXR9Jy8+XCJcblxuY2xhc3MgQ29ubmVjdGlvblxuXG4gICAgY29uc3RydWN0b3I6IChAbmFtZSwgQGZsb3csIHNvdXJjZSwgc2luaywgQGNoYW5uZWxzKSAtPlxuICAgICAgICBAc291cmNlID0gQGZsb3cuZ2V0U3lzdGVtKHNvdXJjZSlcbiAgICAgICAgQHNpbmsgPSBAZmxvdy5nZXRTeXN0ZW0oc2luaylcblxuICAgIHNlcmlhbGl6ZTogLT5cbiAgICAgICAgICAgIHhtbCA9IFwiXCJcIlxuICAgICAgICAgICAgPGNvbm5lY3Rpb24gbmFtZT0nI3tAbmFtZX0nPlxuICAgICAgICAgICAgICAgICN7QHNvdXJjZS5zZXJpYWxpemUoKX1cbiAgICAgICAgICAgICAgICAje0BzaW5rLnNlcmlhbGl6ZSgpfVxuICAgICAgICAgICAgXCJcIlwiXG5cbiAgICAgICAgICAgIGlmIEBjaGFubmVsc1xuICAgICAgICAgICAgICAgIHhtbCArPSBcIjxjaGFubmVscz5cIlxuICAgICAgICAgICAgICAgIGZvciBjaGFubmVsIGluIEBjaGFubmVsc1xuICAgICAgICAgICAgICAgICAgICB4bWwgKz0gY2hhbm5lbC5zZXJpYWxpemUoKVxuICAgICAgICAgICAgICAgIHhtbCArPSBcIjwvY2hhbm5lbHM+XCJcblxuICAgICAgICAgICAgeG1sICs9IFwiPC9jb25uZWN0aW9uPlwiXG5cbmNsYXNzIE1lc3NhZ2VcblxuICAgIGNvbnN0cnVjdG9yOiAoQGV2ZW50LCBAcGF5bG9hZCkgLT5cblxuY2xhc3MgU3RhdGVCdXNcblxuICAgIGNvbnN0cnVjdG9yOiAtPlxuICAgICAgICBAZW50aXRpZXMgPSB7fVxuICAgICAgICBAZGlzY3JldGVTeXN0ZW1zID0ge31cblxuICAgIGFkZEVudGl0eTogKGVudGl0eSkgLT5cbiAgICAgICAgQGVudGl0aWVzW2VudGl5Lm5hbWVdID0gZW50aXR5XG5cbiAgICBnZXRFbnRpdHk6IChuYW1lLCBjcmVhdGUpIC0+XG4gICAgICAgIGlmIEBlbnRpdGllc1tuYW1lXVxuICAgICAgICAgICAgcmV0dXJuIEBlbnRpdGllc1tuYW1lXVxuICAgICAgICBlbHNlIGlmIGNyZWF0ZVxuICAgICAgICAgICAgQGVudGl0aWVzW25hbWVdID0ge31cbiAgICAgICAgICAgIHJldHVybiBAZW50aXRpZXNbbmFtZV1cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgcmV0dXJuIG51bGxcblxuICAgIGFkZERpc2NyZXRlU3lzdGVtOiAoZGlzY3JldGVfc3lzdGVtLCBldmVudHMpIC0+XG5cbiAgICAgICAgZm9yIGV2ZW50IGluIGV2ZW50c1xuXG4gICAgICAgICAgICBpZiBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XS5zeXN0ZW1zIGlzIG51bGxcbiAgICAgICAgICAgICAgICBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XS5zeXN0ZW1zID0gW2Rpc2NyZXRlX3N5c3RlbV1cbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XS5zeXN0ZW1zLmFwcGVuZChkaXNjcmV0ZV9zeXN0ZW0pXG5cbiAgICAgICAgdHJpZ2dlcjogKGV2ZW50LCBtZXNzYWdlKSAtPlxuXG4gICAgICAgICAgICBmb3Igc3lzdGVtIGluIEBkaXNjcmV0ZVN5c3RlbXNbZXZlbnRdXG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9LSBNZXNzYWdlKGV2ZW50LCBtZXNzYWdlKVxuICAgICAgICAgICAgICAgIHN5c3RlbS5yYWlzZShtZXNzYWdlKVxuXG5jbGFzcyBGbG93XG5cbiAgICBjb25zdHJ1Y3RvcjogLT5cblxuICAgICAgICAjIGNvdWxkIGJlIGEgb3JkZXJlZCBtYXBcbiAgICAgICAgQGNvbm5lY3Rpb25zID0gW11cbiAgICAgICAgQGJ1cyA9IG5ldyBTdGF0ZUJ1c1xuICAgICAgICBAc3lzdGVtcyA9IHt9XG5cbiAgICBhZGRTeXN0ZW06IChzeXN0ZW0pIC0+XG4gICAgICAgIEBzeXN0ZW1zW3N5c3RlbS5uYW1lXSA9IHN5c3RlbVxuXG4gICAgZ2V0U3lzdGVtOiAobmFtZSkgLT5cbiAgICAgICAgQHN5c3RlbXNbbmFtZV1cblxuICAgIGFkZENvbm5lY3Rpb246IChjb25uZWN0aW9uKSAtPlxuICAgICAgICBAY29ubmVjdGlvbnMucHVzaChjb25uZWN0aW9uKVxuXG4gICAgc2VyaWFsaXplOiAtPlxuICAgICAgICB4bWwgPSBcIjx4bWw+XCJcbiAgICAgICAgeG1sICs9IFwiPGZsb3cgbmFtZT0nI3tAbmFtZX0nPlwiXG5cbiAgICAgICAgZm9yIGNvbm5lY3Rpb24gaW4gQGNvbm5lY3Rpb25zXG4gICAgICAgICAgICB4bWwgKz0gXCI8Y29ubmVjdGlvbj5cIlxuICAgICAgICAgICAgeG1sICs9IGNvbm5lY3Rpb24uc2VyaWFsaXplKClcbiAgICAgICAgICAgIHhtbCArPSBcIjwvY29ubmVjdGlvbj5cIlxuXG4gICAgICAgIHhtbCA9IFwiPC9mbG93PlwiXG4gICAgICAgIHhtbCA9IFwiPC94bWw+XCJcblxuICAgIGxvZzogKHgpIC0+XG4gICAgICAgIGNvbnNvbGUubG9nKHgpXG5cbiAgICBzdGFydDogLT5cblxuICAgICAgICBmb3IgY29ubmVjdGlvbiBpbiBAY29ubmVjdGlvbnNcblxuICAgICAgICAgICAgQSA9IGNvbm5lY3Rpb24uc291cmNlXG4gICAgICAgICAgICBCID0gY29ubmVjdGlvbi5zaW5rXG5cbiAgICAgICAgICAgIHRoaXMubG9nKFwiI3tBLm5hbWV9IC0tICN7Qi5uYW1lfVwiKVxuXG4gICAgICAgICAgICBpZiBjb25uZWN0aW9uLmNoYW5uZWxzXG4gICAgICAgICAgICAgICAgZm9yIGNoYW5uZWwgaW4gY29ubmVjdGlvbi5jaGFubmVsc1xuICAgICAgICAgICAgICAgICAgICBBLndoZW5SZWFkeSgoKGRhdGEpIC0+XG4gICAgICAgICAgICAgICAgICAgICAgICBCLnB1c2goaW5sZXQsIGRhdGEpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIEEuY2hhbm5lbC5vdXRsZXQpXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgQS53aGVuUmVhZHkgKGRhdGEpIC0+XG4gICAgICAgICAgICAgICAgICAgIEIucHVzaChkYXRhKVxuXG5cbmV4cG9ydHMuU3lzdGVtID0gU3lzdGVtXG5leHBvcnRzLkNoYW5uZWwgPSBDaGFubmVsXG5leHBvcnRzLkNvbm5lY3Rpb24gPSBDb25uZWN0aW9uXG5leHBvcnRzLk1lc3NhZ2UgPSBNZXNzYWdlXG5leHBvcnRzLlN0YXRlQnVzID0gU3RhdGVCdXNcbmV4cG9ydHMuRmxvdyA9IEZsb3dcblxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9