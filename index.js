var Channel, Connection, Entity, Flow, Message, StateBus, System;

System = (function() {
  function System(name, flow) {
    this.name = name;
    this.flow = flow;
    this.handlers = null;
  }

  System.prototype.push = function(data, inlet) {};

  System.prototype.whenReady = function(handler, outlet) {
    if (!outlet) {
      if (this.handlers) {
        return this.handlers.push(handler);
      } else {
        return this.handlers = [handler];
      }
    } else {
      if (this.handlers.outlet === null) {
        return this.handlers.outlet = [handler];
      } else {
        return this.handlers.outlet.push(handler);
      }
    }
  };

  System.prototype.emit = function(data, outlet) {
    var handler, _i, _j, _len, _len1, _ref, _ref1, _results, _results1;
    if (!outlet) {
      _ref = this.handlers;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        handler = _ref[_i];
        _results.push(handler(data));
      }
      return _results;
    } else {
      _ref1 = this.handlers[outlet];
      _results1 = [];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        handler = _ref1[_j];
        _results1.push(handler(data));
      }
      return _results1;
    }
  };

  System.prototype.serialize = function() {
    return "<system name=\"" + this.name + "\" />";
  };

  return System;

})();

Channel = (function() {
  function Channel(inlet, outlet) {
    this.inlet = inlet;
    this.outlet = outlet;
  }

  Channel.prototype.serialize = function() {
    return "<channel inlet='" + this.inlet + "', outlet='" + this.outlet + "'/>";
  };

  return Channel;

})();

Connection = (function() {
  function Connection(name, flow, source, sink, channels) {
    this.name = name;
    this.flow = flow;
    this.channels = channels;
    this.source = this.flow.getSystem(source);
    console.log(this.source);
    this.sink = this.flow.getSystem(sink);
  }

  Connection.prototype.serialize = function() {
    var channel, xml, _i, _len, _ref;
    xml = "<connection name='" + this.name + "'>\n    " + (this.source.serialize()) + "\n    " + (this.sink.serialize());
    if (this.channels) {
      xml += "<channels>";
      _ref = this.channels;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        channel = _ref[_i];
        xml += channel.serialize();
      }
      xml += "</channels>";
    }
    return xml += "</connection>";
  };

  return Connection;

})();

Message = (function() {
  function Message(event, payload) {
    this.event = event;
    this.payload = payload;
  }

  return Message;

})();

Entity = (function() {
  function Entity(name) {
    this.name = name;
  }

  return Entity;

})();

StateBus = (function() {
  function StateBus() {
    this.entities = {};
    this.discreteSystems = {};
  }

  StateBus.prototype.createEntity = function(name) {
    this.entities[name] = new Entity();
    return this.entities[name];
  };

  StateBus.prototype.getEntity = function(name, create) {
    if (this.entities[name]) {
      return this.entities[name];
    } else if (create) {
      return this.createEntity(name);
    } else {
      return null;
    }
  };

  StateBus.prototype.addDiscreteSystem = function(discrete_system, events) {
    var event, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = events.length; _i < _len; _i++) {
      event = events[_i];
      if (this.discreteSystems[event].systems === null) {
        _results.push(this.discreteSystems[event].systems = [discrete_system]);
      } else {
        _results.push(this.discreteSystems[event].systems.append(discrete_system));
      }
    }
    return _results;
  };

  StateBus.prototype.trigger = function(event, message) {
    var system, _i, _len, _ref, _results;
    _ref = this.discreteSystems[event];
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      system = _ref[_i];
      message = -Message(event, message);
      _results.push(system.raise(message));
    }
    return _results;
  };

  return StateBus;

})();

Flow = (function() {
  function Flow() {
    this.connections = [];
    this.bus = new StateBus;
    this.systems = {};
  }

  Flow.prototype.addSystem = function(system) {
    return this.systems[system.name] = system;
  };

  Flow.prototype.getSystem = function(name) {
    return this.systems[name];
  };

  Flow.prototype.addConnection = function(connection) {
    return this.connections.push(connection);
  };

  Flow.prototype.serialize = function() {
    var connection, xml, _i, _len, _ref;
    xml = "<xml>";
    xml += "<flow name='" + this.name + "'>";
    _ref = this.connections;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      connection = _ref[_i];
      xml += "<connection>";
      xml += connection.serialize();
      xml += "</connection>";
    }
    xml = "</flow>";
    return xml = "</xml>";
  };

  Flow.prototype.log = function(x) {
    return console.log(x);
  };

  Flow.prototype.start = function() {
    var A, B, channel, conn, _i, _len, _ref, _results;
    _ref = this.connections;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      conn = _ref[_i];
      A = conn.source;
      B = conn.sink;
      if (conn.channels) {
        _results.push((function() {
          var _j, _len1, _ref1, _results1;
          _ref1 = conn.channels;
          _results1 = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            channel = _ref1[_j];
            _results1.push(A.whenReady((function(data) {
              return B.push(inlet, data);
            }), A.channel.outlet));
          }
          return _results1;
        })());
      } else {
        _results.push(A.whenReady(function(data) {
          return B.push(data);
        }));
      }
    }
    return _results;
  };

  return Flow;

})();

exports.System = System;

exports.Channel = Channel;

exports.Connection = Connection;

exports.Message = Message;

exports.StateBus = StateBus;

exports.Flow = Flow;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzIjpbImluZGV4LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLDREQUFBOztBQUFBO0FBRWdCLEVBQUEsZ0JBQUUsSUFBRixFQUFTLElBQVQsR0FBQTtBQUNSLElBRFMsSUFBQyxDQUFBLE9BQUEsSUFDVixDQUFBO0FBQUEsSUFEZ0IsSUFBQyxDQUFBLE9BQUEsSUFDakIsQ0FBQTtBQUFBLElBQUEsSUFBQyxDQUFBLFFBQUQsR0FBWSxJQUFaLENBRFE7RUFBQSxDQUFaOztBQUFBLG1CQUlBLElBQUEsR0FBTSxTQUFDLElBQUQsRUFBTyxLQUFQLEdBQUEsQ0FKTixDQUFBOztBQUFBLG1CQU1BLFNBQUEsR0FBVyxTQUFDLE9BQUQsRUFBVSxNQUFWLEdBQUE7QUFFUCxJQUFBLElBQUcsQ0FBQSxNQUFIO0FBQ0ksTUFBQSxJQUFHLElBQUMsQ0FBQSxRQUFKO2VBQ0ksSUFBQyxDQUFBLFFBQVEsQ0FBQyxJQUFWLENBQWUsT0FBZixFQURKO09BQUEsTUFBQTtlQUdHLElBQUMsQ0FBQSxRQUFELEdBQVksQ0FBQyxPQUFELEVBSGY7T0FESjtLQUFBLE1BQUE7QUFPSSxNQUFBLElBQUcsSUFBQyxDQUFBLFFBQVEsQ0FBQyxNQUFWLEtBQW9CLElBQXZCO2VBQ0ksSUFBQyxDQUFBLFFBQVEsQ0FBQyxNQUFWLEdBQW1CLENBQUMsT0FBRCxFQUR2QjtPQUFBLE1BQUE7ZUFHSSxJQUFDLENBQUEsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFqQixDQUFzQixPQUF0QixFQUhKO09BUEo7S0FGTztFQUFBLENBTlgsQ0FBQTs7QUFBQSxtQkFvQkEsSUFBQSxHQUFNLFNBQUMsSUFBRCxFQUFPLE1BQVAsR0FBQTtBQUVGLFFBQUEsOERBQUE7QUFBQSxJQUFBLElBQUcsQ0FBQSxNQUFIO0FBQ0k7QUFBQTtXQUFBLDJDQUFBOzJCQUFBO0FBQ0ksc0JBQUEsT0FBQSxDQUFRLElBQVIsRUFBQSxDQURKO0FBQUE7c0JBREo7S0FBQSxNQUFBO0FBSUk7QUFBQTtXQUFBLDhDQUFBOzRCQUFBO0FBQ0ksdUJBQUEsT0FBQSxDQUFRLElBQVIsRUFBQSxDQURKO0FBQUE7dUJBSko7S0FGRTtFQUFBLENBcEJOLENBQUE7O0FBQUEsbUJBNkJBLFNBQUEsR0FBVyxTQUFBLEdBQUE7V0FDSixpQkFBQSxHQUNHLElBQUMsQ0FBQSxJQURKLEdBQ1UsUUFGTjtFQUFBLENBN0JYLENBQUE7O2dCQUFBOztJQUZKLENBQUE7O0FBQUE7QUFzQ2lCLEVBQUEsaUJBQUUsS0FBRixFQUFVLE1BQVYsR0FBQTtBQUFtQixJQUFsQixJQUFDLENBQUEsUUFBQSxLQUFpQixDQUFBO0FBQUEsSUFBVixJQUFDLENBQUEsU0FBQSxNQUFTLENBQW5CO0VBQUEsQ0FBYjs7QUFBQSxvQkFFQSxTQUFBLEdBQVcsU0FBQSxHQUFBO1dBQ04sa0JBQUEsR0FBaUIsSUFBQyxDQUFBLEtBQWxCLEdBQXlCLGFBQXpCLEdBQXFDLElBQUMsQ0FBQSxNQUF0QyxHQUE4QyxNQUR4QztFQUFBLENBRlgsQ0FBQTs7aUJBQUE7O0lBdENKLENBQUE7O0FBQUE7QUE2Q2lCLEVBQUEsb0JBQUUsSUFBRixFQUFTLElBQVQsRUFBZSxNQUFmLEVBQXVCLElBQXZCLEVBQThCLFFBQTlCLEdBQUE7QUFDVCxJQURVLElBQUMsQ0FBQSxPQUFBLElBQ1gsQ0FBQTtBQUFBLElBRGlCLElBQUMsQ0FBQSxPQUFBLElBQ2xCLENBQUE7QUFBQSxJQURzQyxJQUFDLENBQUEsV0FBQSxRQUN2QyxDQUFBO0FBQUEsSUFBQSxJQUFDLENBQUEsTUFBRCxHQUFVLElBQUMsQ0FBQSxJQUFJLENBQUMsU0FBTixDQUFnQixNQUFoQixDQUFWLENBQUE7QUFBQSxJQUNBLE9BQU8sQ0FBQyxHQUFSLENBQVksSUFBQyxDQUFBLE1BQWIsQ0FEQSxDQUFBO0FBQUEsSUFFQSxJQUFDLENBQUEsSUFBRCxHQUFRLElBQUMsQ0FBQSxJQUFJLENBQUMsU0FBTixDQUFnQixJQUFoQixDQUZSLENBRFM7RUFBQSxDQUFiOztBQUFBLHVCQUtBLFNBQUEsR0FBVyxTQUFBLEdBQUE7QUFDSCxRQUFBLDRCQUFBO0FBQUEsSUFBQSxHQUFBLEdBQVMsb0JBQUEsR0FDSCxJQUFDLENBQUEsSUFERSxHQUNJLFVBREosR0FDWSxDQUFBLElBQUMsQ0FBQSxNQUFNLENBQUMsU0FBUixDQUFBLENBQUEsQ0FEWixHQUVSLFFBRlEsR0FFRixDQUFBLElBQUMsQ0FBQSxJQUFJLENBQUMsU0FBTixDQUFBLENBQUEsQ0FGUCxDQUFBO0FBTUEsSUFBQSxJQUFHLElBQUMsQ0FBQSxRQUFKO0FBQ0ksTUFBQSxHQUFBLElBQU8sWUFBUCxDQUFBO0FBQ0E7QUFBQSxXQUFBLDJDQUFBOzJCQUFBO0FBQ0ksUUFBQSxHQUFBLElBQU8sT0FBTyxDQUFDLFNBQVIsQ0FBQSxDQUFQLENBREo7QUFBQSxPQURBO0FBQUEsTUFHQSxHQUFBLElBQU8sYUFIUCxDQURKO0tBTkE7V0FZQSxHQUFBLElBQU8sZ0JBYko7RUFBQSxDQUxYLENBQUE7O29CQUFBOztJQTdDSixDQUFBOztBQUFBO0FBbUVpQixFQUFBLGlCQUFFLEtBQUYsRUFBVSxPQUFWLEdBQUE7QUFBb0IsSUFBbkIsSUFBQyxDQUFBLFFBQUEsS0FBa0IsQ0FBQTtBQUFBLElBQVgsSUFBQyxDQUFBLFVBQUEsT0FBVSxDQUFwQjtFQUFBLENBQWI7O2lCQUFBOztJQW5FSixDQUFBOztBQUFBO0FBdUVpQixFQUFBLGdCQUFFLElBQUYsR0FBQTtBQUFTLElBQVIsSUFBQyxDQUFBLE9BQUEsSUFBTyxDQUFUO0VBQUEsQ0FBYjs7Z0JBQUE7O0lBdkVKLENBQUE7O0FBQUE7QUEyRWlCLEVBQUEsa0JBQUEsR0FBQTtBQUNULElBQUEsSUFBQyxDQUFBLFFBQUQsR0FBWSxFQUFaLENBQUE7QUFBQSxJQUNBLElBQUMsQ0FBQSxlQUFELEdBQW1CLEVBRG5CLENBRFM7RUFBQSxDQUFiOztBQUFBLHFCQUlBLFlBQUEsR0FBYyxTQUFDLElBQUQsR0FBQTtBQUNWLElBQUEsSUFBQyxDQUFBLFFBQVMsQ0FBQSxJQUFBLENBQVYsR0FBc0IsSUFBQSxNQUFBLENBQUEsQ0FBdEIsQ0FBQTtXQUNBLElBQUMsQ0FBQSxRQUFTLENBQUEsSUFBQSxFQUZBO0VBQUEsQ0FKZCxDQUFBOztBQUFBLHFCQVFBLFNBQUEsR0FBVyxTQUFDLElBQUQsRUFBTyxNQUFQLEdBQUE7QUFDUCxJQUFBLElBQUcsSUFBQyxDQUFBLFFBQVMsQ0FBQSxJQUFBLENBQWI7QUFDSSxhQUFPLElBQUMsQ0FBQSxRQUFTLENBQUEsSUFBQSxDQUFqQixDQURKO0tBQUEsTUFFSyxJQUFHLE1BQUg7QUFDRCxhQUFPLElBQUksQ0FBQyxZQUFMLENBQWtCLElBQWxCLENBQVAsQ0FEQztLQUFBLE1BQUE7QUFHRCxhQUFPLElBQVAsQ0FIQztLQUhFO0VBQUEsQ0FSWCxDQUFBOztBQUFBLHFCQWdCQSxpQkFBQSxHQUFtQixTQUFDLGVBQUQsRUFBa0IsTUFBbEIsR0FBQTtBQUVmLFFBQUEseUJBQUE7QUFBQTtTQUFBLDZDQUFBO3lCQUFBO0FBRUksTUFBQSxJQUFHLElBQUMsQ0FBQSxlQUFnQixDQUFBLEtBQUEsQ0FBTSxDQUFDLE9BQXhCLEtBQW1DLElBQXRDO3NCQUNJLElBQUMsQ0FBQSxlQUFnQixDQUFBLEtBQUEsQ0FBTSxDQUFDLE9BQXhCLEdBQWtDLENBQUMsZUFBRCxHQUR0QztPQUFBLE1BQUE7c0JBR0ksSUFBQyxDQUFBLGVBQWdCLENBQUEsS0FBQSxDQUFNLENBQUMsT0FBTyxDQUFDLE1BQWhDLENBQXVDLGVBQXZDLEdBSEo7T0FGSjtBQUFBO29CQUZlO0VBQUEsQ0FoQm5CLENBQUE7O0FBQUEscUJBeUJBLE9BQUEsR0FBUyxTQUFDLEtBQUQsRUFBUSxPQUFSLEdBQUE7QUFFTCxRQUFBLGdDQUFBO0FBQUE7QUFBQTtTQUFBLDJDQUFBO3dCQUFBO0FBQ0ksTUFBQSxPQUFBLEdBQVMsQ0FBQSxPQUFFLENBQVEsS0FBUixFQUFlLE9BQWYsQ0FBWCxDQUFBO0FBQUEsb0JBQ0EsTUFBTSxDQUFDLEtBQVAsQ0FBYSxPQUFiLEVBREEsQ0FESjtBQUFBO29CQUZLO0VBQUEsQ0F6QlQsQ0FBQTs7a0JBQUE7O0lBM0VKLENBQUE7O0FBQUE7QUE0R2lCLEVBQUEsY0FBQSxHQUFBO0FBR1QsSUFBQSxJQUFDLENBQUEsV0FBRCxHQUFlLEVBQWYsQ0FBQTtBQUFBLElBQ0EsSUFBQyxDQUFBLEdBQUQsR0FBTyxHQUFBLENBQUEsUUFEUCxDQUFBO0FBQUEsSUFFQSxJQUFDLENBQUEsT0FBRCxHQUFXLEVBRlgsQ0FIUztFQUFBLENBQWI7O0FBQUEsaUJBT0EsU0FBQSxHQUFXLFNBQUMsTUFBRCxHQUFBO1dBQ1AsSUFBQyxDQUFBLE9BQVEsQ0FBQSxNQUFNLENBQUMsSUFBUCxDQUFULEdBQXdCLE9BRGpCO0VBQUEsQ0FQWCxDQUFBOztBQUFBLGlCQVVBLFNBQUEsR0FBVyxTQUFDLElBQUQsR0FBQTtXQUNQLElBQUMsQ0FBQSxPQUFRLENBQUEsSUFBQSxFQURGO0VBQUEsQ0FWWCxDQUFBOztBQUFBLGlCQWFBLGFBQUEsR0FBZSxTQUFDLFVBQUQsR0FBQTtXQUNYLElBQUMsQ0FBQSxXQUFXLENBQUMsSUFBYixDQUFrQixVQUFsQixFQURXO0VBQUEsQ0FiZixDQUFBOztBQUFBLGlCQWdCQSxTQUFBLEdBQVcsU0FBQSxHQUFBO0FBQ1AsUUFBQSwrQkFBQTtBQUFBLElBQUEsR0FBQSxHQUFNLE9BQU4sQ0FBQTtBQUFBLElBQ0EsR0FBQSxJQUFRLGNBQUEsR0FBYSxJQUFDLENBQUEsSUFBZCxHQUFvQixJQUQ1QixDQUFBO0FBR0E7QUFBQSxTQUFBLDJDQUFBOzRCQUFBO0FBQ0ksTUFBQSxHQUFBLElBQU8sY0FBUCxDQUFBO0FBQUEsTUFDQSxHQUFBLElBQU8sVUFBVSxDQUFDLFNBQVgsQ0FBQSxDQURQLENBQUE7QUFBQSxNQUVBLEdBQUEsSUFBTyxlQUZQLENBREo7QUFBQSxLQUhBO0FBQUEsSUFRQSxHQUFBLEdBQU0sU0FSTixDQUFBO1dBU0EsR0FBQSxHQUFNLFNBVkM7RUFBQSxDQWhCWCxDQUFBOztBQUFBLGlCQTRCQSxHQUFBLEdBQUssU0FBQyxDQUFELEdBQUE7V0FDRCxPQUFPLENBQUMsR0FBUixDQUFZLENBQVosRUFEQztFQUFBLENBNUJMLENBQUE7O0FBQUEsaUJBK0JBLEtBQUEsR0FBTyxTQUFBLEdBQUE7QUFFSCxRQUFBLDZDQUFBO0FBQUE7QUFBQTtTQUFBLDJDQUFBO3NCQUFBO0FBRUksTUFBQSxDQUFBLEdBQUksSUFBSSxDQUFDLE1BQVQsQ0FBQTtBQUFBLE1BQ0EsQ0FBQSxHQUFJLElBQUksQ0FBQyxJQURULENBQUE7QUFHQSxNQUFBLElBQUcsSUFBSSxDQUFDLFFBQVI7OztBQUNJO0FBQUE7ZUFBQSw4Q0FBQTtnQ0FBQTtBQUNJLDJCQUFBLENBQUMsQ0FBQyxTQUFGLENBQVksQ0FBQyxTQUFDLElBQUQsR0FBQTtxQkFDVCxDQUFDLENBQUMsSUFBRixDQUFPLEtBQVAsRUFBYyxJQUFkLEVBRFM7WUFBQSxDQUFELENBQVosRUFFSSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BRmQsRUFBQSxDQURKO0FBQUE7O2NBREo7T0FBQSxNQUFBO3NCQU1JLENBQUMsQ0FBQyxTQUFGLENBQVksU0FBQyxJQUFELEdBQUE7aUJBQ1IsQ0FBQyxDQUFDLElBQUYsQ0FBTyxJQUFQLEVBRFE7UUFBQSxDQUFaLEdBTko7T0FMSjtBQUFBO29CQUZHO0VBQUEsQ0EvQlAsQ0FBQTs7Y0FBQTs7SUE1R0osQ0FBQTs7QUFBQSxPQTRKTyxDQUFDLE1BQVIsR0FBaUIsTUE1SmpCLENBQUE7O0FBQUEsT0E2Sk8sQ0FBQyxPQUFSLEdBQWtCLE9BN0psQixDQUFBOztBQUFBLE9BOEpPLENBQUMsVUFBUixHQUFxQixVQTlKckIsQ0FBQTs7QUFBQSxPQStKTyxDQUFDLE9BQVIsR0FBa0IsT0EvSmxCLENBQUE7O0FBQUEsT0FnS08sQ0FBQyxRQUFSLEdBQW1CLFFBaEtuQixDQUFBOztBQUFBLE9BaUtPLENBQUMsSUFBUixHQUFlLElBaktmLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBTeXN0ZW1cblxuICAgIGNvbnN0cnVjdG9yOihAbmFtZSwgQGZsb3cpIC0+XG4gICAgICAgIEBoYW5kbGVycyA9IG51bGxcblxuICAgICMganVzdCBkYXRhIGZvciBzaW5nbGUgaW5sZXRcbiAgICBwdXNoOiAoZGF0YSwgaW5sZXQpIC0+XG5cbiAgICB3aGVuUmVhZHk6IChoYW5kbGVyLCBvdXRsZXQpIC0+XG5cbiAgICAgICAgaWYgbm90IG91dGxldFxuICAgICAgICAgICAgaWYgQGhhbmRsZXJzXG4gICAgICAgICAgICAgICAgQGhhbmRsZXJzLnB1c2goaGFuZGxlcilcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgIEBoYW5kbGVycyA9IFtoYW5kbGVyXVxuXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGlmIEBoYW5kbGVycy5vdXRsZXQgaXMgbnVsbFxuICAgICAgICAgICAgICAgIEBoYW5kbGVycy5vdXRsZXQgPSBbaGFuZGxlcl1cbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBAaGFuZGxlcnMub3V0bGV0LnB1c2ggaGFuZGxlclxuXG4gICAgZW1pdDogKGRhdGEsIG91dGxldCkgLT5cblxuICAgICAgICBpZiBub3Qgb3V0bGV0XG4gICAgICAgICAgICBmb3IgaGFuZGxlciBpbiBAaGFuZGxlcnNcbiAgICAgICAgICAgICAgICBoYW5kbGVyKGRhdGEpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGZvciBoYW5kbGVyIGluIEBoYW5kbGVyc1tvdXRsZXRdXG4gICAgICAgICAgICAgICAgaGFuZGxlcihkYXRhKVxuXG4gICAgc2VyaWFsaXplOiAtPlxuICAgICAgICBcIlwiXCJcbiAgICAgICAgPHN5c3RlbSBuYW1lPVwiI3tAbmFtZX1cIiAvPlxuICAgICAgICBcIlwiXCJcblxuY2xhc3MgQ2hhbm5lbFxuXG4gICAgY29uc3RydWN0b3I6IChAaW5sZXQsIEBvdXRsZXQpIC0+XG5cbiAgICBzZXJpYWxpemU6IC0+XG4gICAgICAgIFwiPGNoYW5uZWwgaW5sZXQ9JyN7QGlubGV0fScsIG91dGxldD0nI3tAb3V0bGV0fScvPlwiXG5cbmNsYXNzIENvbm5lY3Rpb25cblxuICAgIGNvbnN0cnVjdG9yOiAoQG5hbWUsIEBmbG93LCBzb3VyY2UsIHNpbmssIEBjaGFubmVscykgLT5cbiAgICAgICAgQHNvdXJjZSA9IEBmbG93LmdldFN5c3RlbShzb3VyY2UpXG4gICAgICAgIGNvbnNvbGUubG9nKEBzb3VyY2UpXG4gICAgICAgIEBzaW5rID0gQGZsb3cuZ2V0U3lzdGVtKHNpbmspXG5cbiAgICBzZXJpYWxpemU6IC0+XG4gICAgICAgICAgICB4bWwgPSBcIlwiXCJcbiAgICAgICAgICAgIDxjb25uZWN0aW9uIG5hbWU9JyN7QG5hbWV9Jz5cbiAgICAgICAgICAgICAgICAje0Bzb3VyY2Uuc2VyaWFsaXplKCl9XG4gICAgICAgICAgICAgICAgI3tAc2luay5zZXJpYWxpemUoKX1cbiAgICAgICAgICAgIFwiXCJcIlxuXG4gICAgICAgICAgICBpZiBAY2hhbm5lbHNcbiAgICAgICAgICAgICAgICB4bWwgKz0gXCI8Y2hhbm5lbHM+XCJcbiAgICAgICAgICAgICAgICBmb3IgY2hhbm5lbCBpbiBAY2hhbm5lbHNcbiAgICAgICAgICAgICAgICAgICAgeG1sICs9IGNoYW5uZWwuc2VyaWFsaXplKClcbiAgICAgICAgICAgICAgICB4bWwgKz0gXCI8L2NoYW5uZWxzPlwiXG5cbiAgICAgICAgICAgIHhtbCArPSBcIjwvY29ubmVjdGlvbj5cIlxuXG5jbGFzcyBNZXNzYWdlXG5cbiAgICBjb25zdHJ1Y3RvcjogKEBldmVudCwgQHBheWxvYWQpIC0+XG5cbmNsYXNzIEVudGl0eVxuXG4gICAgY29uc3RydWN0b3I6IChAbmFtZSkgLT5cblxuY2xhc3MgU3RhdGVCdXNcblxuICAgIGNvbnN0cnVjdG9yOiAtPlxuICAgICAgICBAZW50aXRpZXMgPSB7fVxuICAgICAgICBAZGlzY3JldGVTeXN0ZW1zID0ge31cblxuICAgIGNyZWF0ZUVudGl0eTogKG5hbWUpIC0+XG4gICAgICAgIEBlbnRpdGllc1tuYW1lXSA9IG5ldyBFbnRpdHkoKVxuICAgICAgICBAZW50aXRpZXNbbmFtZV1cblxuICAgIGdldEVudGl0eTogKG5hbWUsIGNyZWF0ZSkgLT5cbiAgICAgICAgaWYgQGVudGl0aWVzW25hbWVdXG4gICAgICAgICAgICByZXR1cm4gQGVudGl0aWVzW25hbWVdXG4gICAgICAgIGVsc2UgaWYgY3JlYXRlXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVFbnRpdHkobmFtZSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgcmV0dXJuIG51bGxcblxuICAgIGFkZERpc2NyZXRlU3lzdGVtOiAoZGlzY3JldGVfc3lzdGVtLCBldmVudHMpIC0+XG5cbiAgICAgICAgZm9yIGV2ZW50IGluIGV2ZW50c1xuXG4gICAgICAgICAgICBpZiBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XS5zeXN0ZW1zIGlzIG51bGxcbiAgICAgICAgICAgICAgICBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XS5zeXN0ZW1zID0gW2Rpc2NyZXRlX3N5c3RlbV1cbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XS5zeXN0ZW1zLmFwcGVuZChkaXNjcmV0ZV9zeXN0ZW0pXG5cbiAgICB0cmlnZ2VyOiAoZXZlbnQsIG1lc3NhZ2UpIC0+XG5cbiAgICAgICAgZm9yIHN5c3RlbSBpbiBAZGlzY3JldGVTeXN0ZW1zW2V2ZW50XVxuICAgICAgICAgICAgbWVzc2FnZSA9LSBNZXNzYWdlKGV2ZW50LCBtZXNzYWdlKVxuICAgICAgICAgICAgc3lzdGVtLnJhaXNlKG1lc3NhZ2UpXG5cbmNsYXNzIEZsb3dcblxuICAgIGNvbnN0cnVjdG9yOiAtPlxuXG4gICAgICAgICMgY291bGQgYmUgYSBvcmRlcmVkIG1hcFxuICAgICAgICBAY29ubmVjdGlvbnMgPSBbXVxuICAgICAgICBAYnVzID0gbmV3IFN0YXRlQnVzXG4gICAgICAgIEBzeXN0ZW1zID0ge31cblxuICAgIGFkZFN5c3RlbTogKHN5c3RlbSkgLT5cbiAgICAgICAgQHN5c3RlbXNbc3lzdGVtLm5hbWVdID0gc3lzdGVtXG5cbiAgICBnZXRTeXN0ZW06IChuYW1lKSAtPlxuICAgICAgICBAc3lzdGVtc1tuYW1lXVxuXG4gICAgYWRkQ29ubmVjdGlvbjogKGNvbm5lY3Rpb24pIC0+XG4gICAgICAgIEBjb25uZWN0aW9ucy5wdXNoKGNvbm5lY3Rpb24pXG5cbiAgICBzZXJpYWxpemU6IC0+XG4gICAgICAgIHhtbCA9IFwiPHhtbD5cIlxuICAgICAgICB4bWwgKz0gXCI8ZmxvdyBuYW1lPScje0BuYW1lfSc+XCJcblxuICAgICAgICBmb3IgY29ubmVjdGlvbiBpbiBAY29ubmVjdGlvbnNcbiAgICAgICAgICAgIHhtbCArPSBcIjxjb25uZWN0aW9uPlwiXG4gICAgICAgICAgICB4bWwgKz0gY29ubmVjdGlvbi5zZXJpYWxpemUoKVxuICAgICAgICAgICAgeG1sICs9IFwiPC9jb25uZWN0aW9uPlwiXG5cbiAgICAgICAgeG1sID0gXCI8L2Zsb3c+XCJcbiAgICAgICAgeG1sID0gXCI8L3htbD5cIlxuXG4gICAgbG9nOiAoeCkgLT5cbiAgICAgICAgY29uc29sZS5sb2coeClcblxuICAgIHN0YXJ0OiAtPlxuXG4gICAgICAgIGZvciBjb25uIGluIEBjb25uZWN0aW9uc1xuXG4gICAgICAgICAgICBBID0gY29ubi5zb3VyY2VcbiAgICAgICAgICAgIEIgPSBjb25uLnNpbmtcblxuICAgICAgICAgICAgaWYgY29ubi5jaGFubmVsc1xuICAgICAgICAgICAgICAgIGZvciBjaGFubmVsIGluIGNvbm4uY2hhbm5lbHNcbiAgICAgICAgICAgICAgICAgICAgQS53aGVuUmVhZHkoKChkYXRhKSAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgQi5wdXNoKGlubGV0LCBkYXRhKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBBLmNoYW5uZWwub3V0bGV0KVxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIEEud2hlblJlYWR5IChkYXRhKSAtPlxuICAgICAgICAgICAgICAgICAgICBCLnB1c2goZGF0YSlcblxuXG5leHBvcnRzLlN5c3RlbSA9IFN5c3RlbVxuZXhwb3J0cy5DaGFubmVsID0gQ2hhbm5lbFxuZXhwb3J0cy5Db25uZWN0aW9uID0gQ29ubmVjdGlvblxuZXhwb3J0cy5NZXNzYWdlID0gTWVzc2FnZVxuZXhwb3J0cy5TdGF0ZUJ1cyA9IFN0YXRlQnVzXG5leHBvcnRzLkZsb3cgPSBGbG93XG5cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==